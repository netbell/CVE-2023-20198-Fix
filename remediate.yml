---
- name: Remediate Cisco CVE-2023-20198
  hosts: iosxe_devices
  gather_facts: no

  tasks:
    - name: Check if Web service is running on router
      cisco.ios.command:
        commands: show running-config | include ip http server|secure|active
      register: web_service_status

    - name: Print Web service status
      ansible.builtin.debug:
        var: web_service_status.stdout_lines[0]

    - name: Disable Web User Interface of Cisco IOS XE if active
      cisco.ios.ios_config:
        lines:
          - no ip http server
          - no ip http secure-server
      when: "'no ip http server' not in web_service_status.stdout[0] or 'no ip http secure-server' not in web_service_status.stdout[0]"
      register: web_ui_disable

    - name: Save configuration if changed
      cisco.ios.ios_command:
        commands: write memory
      when: web_ui_disable.changed

    - name: Determine if exploit exists in syslogs
      cisco.ios.command:
        commands:
          - 'sh logging | i %SYS-5-CONFIG_P: Configured programmatically by process SEP_webui_wsma_http from console as'
          - 'sh logging | i %SEC_LOGIN-5-WEBLOGIN_SUCCESS: Login Success'
          - 'sh logging | i %WEBUI-6-INSTALL_OPERATION_INFO:'
          - 'sh logging | i cisco_tac_admin'
          - 'sh logging | i cisco_support'
      register: exploit_logs

    - name: Print exploit log results
      ansible.builtin.debug:
        var: exploit_logs.stdout_lines
